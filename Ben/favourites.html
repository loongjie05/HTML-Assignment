<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Favourites | Jalan Jalan Makan</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../shared/sharedComponent.css">
    <link rel="stylesheet" href="../shared/sharedComponentResponsive.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css"/>
    <style>
    .content { max-width: 1200px; }
    .fav-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; }
    .fav-card { 
        background: #fff; 
        border: 4px solid transparent; 
        border-radius: 12px; 
        overflow: hidden; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.06); 
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
    }
    .fav-card:hover {
        transform: translate(-10px, -10px);
        box-shadow: 10px 10px 0 #ffce1b, 20px 20px 0 #e6b800;
        border-color: #ffce1b;
    }
    
    .fav-card:hover .name {
        color: #e67e22;
    }
    .fav-card:active {
        transform: translate(0, 0);
        box-shadow: 0 4px 12px rgba(0,0,0,0.06);
        border-color: transparent;
    }
    .fav-card .media { 
        height: 150px; 
        background-size: cover; 
        background-position: center;
        position: relative;
    }
    .fav-card .body { padding: 12px; }
    .fav-card .name { font-weight: 600; margin-bottom: 6px; }
    .fav-card .meta { color: #777; font-size: 0.9rem; display: flex; gap: 10px; align-items: center; }
    .empty { color: #777; text-align: center; padding: 40px 0; }
    
    /* Delete button styles */
    .delete-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(230, 57, 70, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        z-index: 10;
    }
    .delete-btn:hover {
        background: rgba(230, 57, 70, 1);
        transform: scale(1.1);
    }
    .delete-btn:active {
        transform: scale(0.95);
    }
    
    /* Image fallback */
    .media img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    </style>
</head>
<body>
    <div id="header"></div>
    <main class="content">
        <section class="page-title" data-aos="fade-up">
            <h1><i class="fa-solid fa-heart" style="color:#e63946"></i> Your Favourites</h1>
            <p>Foods you've marked with the heart icon.</p>
        </section>
        <section data-aos="fade-up" data-aos-delay="100">
            <div id="favGrid" class="fav-grid"></div>
            <div id="favEmpty" class="empty" style="display:none;">No favourites yet.</div>
        </section>
    </main>
    <div id="footer"></div>
    <script src="../shared/sharedComponent.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
    <script>try{ AOS.init({ once:true, duration:600, easing:'ease-out' }); }catch(e){}</script>
    <script src="../shared/data.js"></script>
    <script>
    (function(){
        function loadFavourites() {
            // Check if user is logged in
            const currentUser = getCurrentUser();
            
            // If no user is logged in, show empty favorites but don't delete user data
            if (!currentUser) {
                console.log('No user logged in, showing empty favorites');
                const grid = document.getElementById('favGrid');
                const empty = document.getElementById('favEmpty');
                empty.style.display = 'block';
                grid.innerHTML = '';
                return;
            }
            
            // Check for old favorites and migrate them if needed
            const oldFavorites = JSON.parse(localStorage.getItem('favourites') || '[]');
            let favs = JSON.parse(localStorage.getItem('favoriteFoods') || '[]');
            
            // If we have old favorites but no new ones, migrate them
            if (oldFavorites.length > 0 && favs.length === 0) {
                favs = oldFavorites;
                localStorage.setItem('favoriteFoods', JSON.stringify(favs));
                // Also update user account data
                updateUserFavorites(favs);
                console.log('Migrated old favorites:', favs);
            }
            const foods = (window.SiteData && window.SiteData.foods) ? window.SiteData.foods : [];
            const byTitle = new Map(foods.map(f => [f.title, f]));
            const list = favs.map(t => byTitle.get(t)).filter(Boolean);
            const grid = document.getElementById('favGrid');
            const empty = document.getElementById('favEmpty');
            
            if(list.length === 0){ 
                empty.style.display = 'block'; 
                grid.innerHTML = '';
                return; 
            }
            
            empty.style.display = 'none';
            grid.innerHTML = list.map(item => `
                <div class="fav-card" data-food="${item.title}" onclick="navigateToFoodInfo('${item.title.replace(/'/g, "\\'")}')">
                    <button class="delete-btn" onclick="event.stopPropagation(); removeFavourite('${item.title.replace(/'/g, "\\'")}');" title="Remove from favourites">
                        <i class="fa-solid fa-times"></i>
                    </button>
                    <div class="media">
                        <img src="${item.images?.cover || '../LJ/pictures/cooking.jpg'}" 
                             alt="${item.title}" 
                             onerror="this.src='../LJ/pictures/cooking.jpg'">
                    </div>
                    <div class="body">
                        <div class="name">${item.title}</div>
                        <div class="meta">
                            <i class="fa-solid fa-flag"></i> ${item.country || ''} 
                            <span style="margin-left:auto">
                                <i class="fa-solid fa-globe"></i> ${item.continent || ''}
                            </span>
                        </div>
                        <div style="margin-top: 8px; text-align: center; color: #777; font-size: 0.8rem;">
                            <i class="fa-solid fa-hand-pointer"></i> Click to view details
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Navigate to food info page
        window.navigateToFoodInfo = function(foodTitle) {
            // Provide visual feedback
            const card = event.currentTarget;
            card.style.transform = 'scale(0.95)';
            card.style.transition = 'transform 0.1s ease-out';
            
            // Navigate to FoodInfo.html with the food parameter after short delay
            setTimeout(() => {
                window.location.href = `FoodInfo.html?food=${encodeURIComponent(foodTitle)}`;
            }, 100);
        };
        
        // Remove favourite function
        window.removeFavourite = function(foodTitle) {
            const favs = JSON.parse(localStorage.getItem('favoriteFoods') || '[]');
            const newFavs = favs.filter(f => f !== foodTitle);
            localStorage.setItem('favoriteFoods', JSON.stringify(newFavs));
            
            // Update user account data
            updateUserFavorites(newFavs);
            
            // Reload the favourites display
            loadFavourites();
            
            // Show feedback
            const card = document.querySelector(`[data-food="${foodTitle}"]`);
            if (card) {
                card.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    loadFavourites();
                }, 300);
            }
        };
        
        // Add fadeOut animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeOut {
                from { opacity: 1; transform: scale(1); }
                to { opacity: 0; transform: scale(0.8); }
            }
        `;
        document.head.appendChild(style);
        
        // Initial load
        loadFavourites();
        
        // Listen for storage changes (if user adds/removes favourites from other pages)
        window.addEventListener('storage', function(e) {
            if (e.key === 'favoriteFoods') {
                loadFavourites();
            }
        });

        // Function to get current user from multiple storage sources
        function getCurrentUser() {
            // Try to get user from multiple sources
            let user = null;
            
            // Try localStorage first
            const localUser = localStorage.getItem('activeUserSession');
            if (localUser) {
                try {
                    user = JSON.parse(localUser);
                } catch (e) {
                    console.error('Error parsing localStorage user:', e);
                }
            }
            
            // If no local user, try session storage
            if (!user) {
                const sessionUser = sessionStorage.getItem('currentUser');
                if (sessionUser) {
                    try {
                        user = JSON.parse(sessionUser);
                    } catch (e) {
                        console.error('Error parsing sessionStorage user:', e);
                    }
                }
            }
            
            // If no session user, try cookies
            if (!user) {
                const cookieUser = getCookie('userSession');
                if (cookieUser) {
                    try {
                        user = JSON.parse(cookieUser);
                    } catch (e) {
                        console.error('Error parsing cookie user:', e);
                    }
                }
            }
            
            return user;
        }

        // Cookie helper function
        function getCookie(name) {
            try {
                const nameEQ = name + "=";
                const ca = document.cookie.split(';');
                for (let i = 0; i < ca.length; i++) {
                    let c = ca[i];
                    while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                    if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
                }
                return null;
            } catch (e) {
                console.error('Cookie error:', e);
                return null;
            }
        }

        // Function to update user's favorite foods in their account data
        function updateUserFavorites(favoriteFoods) {
            try {
                // Get current user session
                const userSession = getCurrentUser();
                if (!userSession || !userSession.userId) {
                    console.log('No active user session found');
                    return;
                }

                // Get all users from storage
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                
                // Find the current user
                const userIndex = users.findIndex(user => user.email === userSession.userId);
                
                if (userIndex !== -1) {
                    // Update the user's favoriteFoods
                    users[userIndex].favoriteFoods = favoriteFoods;
                    
                    // Save back to localStorage
                    localStorage.setItem('users', JSON.stringify(users));
                    
                    console.log('Updated user favorites for:', userSession.userId, favoriteFoods);
                } else {
                    console.error('User not found in users array:', userSession.userId);
                }
            } catch (error) {
                console.error('Error updating user favorites:', error);
            }
        }

        // Listen for logout events to clear favorites display
        window.addEventListener('userLogout', function() {
            console.log('User logout detected, clearing favorites display');
            // Clear the current session favorites display but don't delete user data
            localStorage.removeItem('favoriteFoods');
            loadFavourites(); // This will now show empty since no user is logged in
        });

        // Listen for login events to reload favorites
        window.addEventListener('userLogin', function(event) {
            console.log('User login detected, reloading favorites');
            // Reload favorites for the newly logged in user
            setTimeout(() => {
                loadFavourites();
            }, 100);
        });
    })();
    </script>
</body>
</html>
